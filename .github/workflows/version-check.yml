name: Version Check & Auto-Update

on:
  pull_request:
    types: [opened, synchronize, reopened, labeled, unlabeled]
    branches: [ main ]

permissions:
  contents: write
  pull-requests: write

jobs:
  check-and-update-version:
    runs-on: ubuntu-latest
    if: github.event.pull_request.head.repo.full_name == github.repository
    
    steps:
    - name: Checkout PR branch
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event.pull_request.head.ref }}
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '10.0.x'
    
    - name: Install nbgv tool
      run: dotnet tool install -g nbgv
    
    - name: Get current version from main
      id: main_version
      run: |
        git fetch origin main:main
        git checkout main
        MAIN_VERSION=$(nbgv get-version -v Version)
        echo "version=$MAIN_VERSION" >> $GITHUB_OUTPUT
        echo "Main branch version: $MAIN_VERSION"
        git checkout ${{ github.event.pull_request.head.ref }}
    
    - name: Determine version increment from PR
      id: version_type
      run: |
        # Get PR title and labels
        PR_TITLE="${{ github.event.pull_request.title }}"
        PR_LABELS="${{ join(github.event.pull_request.labels.*.name, ' ') }}"
        
        echo "PR Title: $PR_TITLE"
        echo "PR Labels: $PR_LABELS"
        
        # Check for breaking change indicators
        if echo "$PR_TITLE" | grep -qiE '^(feat|fix|chore|docs|style|refactor|perf|test)!:' || \
           echo "$PR_TITLE" | grep -qi 'BREAKING CHANGE' || \
           echo "$PR_LABELS" | grep -qi 'breaking'; then
          echo "type=major" >> $GITHUB_OUTPUT
          echo "Detected: MAJOR version bump (breaking change)"
        # Check for feature/minor bump
        elif echo "$PR_TITLE" | grep -qiE '^feat(\(.+\))?:' || \
             echo "$PR_LABELS" | grep -qiE '(feature|enhancement)'; then
          echo "type=minor" >> $GITHUB_OUTPUT
          echo "Detected: MINOR version bump (feature)"
        # Check for patch/fix
        elif echo "$PR_TITLE" | grep -qiE '^(fix|perf|refactor)(\(.+\))?:' || \
             echo "$PR_LABELS" | grep -qiE '(bug|fix|patch)'; then
          echo "type=patch" >> $GITHUB_OUTPUT
          echo "Detected: PATCH version bump (fix)"
        # Default to patch for other conventional commits
        elif echo "$PR_TITLE" | grep -qiE '^(chore|docs|style|test|build|ci)(\(.+\))?:'; then
          echo "type=patch" >> $GITHUB_OUTPUT
          echo "Detected: PATCH version bump (other changes)"
        else
          echo "type=patch" >> $GITHUB_OUTPUT
          echo "No conventional commit prefix found, defaulting to PATCH"
          echo "warning=true" >> $GITHUB_OUTPUT
        fi
    
    - name: Calculate new version
      id: new_version
      run: |
        MAIN_VERSION="${{ steps.main_version.outputs.version }}"
        INCREMENT_TYPE="${{ steps.version_type.outputs.type }}"
        
        # Parse version components
        IFS='.' read -r MAJOR MINOR PATCH <<< "$MAIN_VERSION"
        
        # Calculate new version based on increment type
        case $INCREMENT_TYPE in
          major)
            NEW_VERSION="$((MAJOR + 1)).0.0"
            ;;
          minor)
            NEW_VERSION="${MAJOR}.$((MINOR + 1)).0"
            ;;
          patch)
            NEW_VERSION="${MAJOR}.${MINOR}.$((PATCH + 1))"
            ;;
          *)
            echo "Invalid increment type: $INCREMENT_TYPE"
            exit 1
            ;;
        esac
        
        echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
        echo "New version will be: $NEW_VERSION"
    
    - name: Get PR branch version
      id: pr_version
      run: |
        PR_VERSION=$(nbgv get-version -v Version)
        echo "version=$PR_VERSION" >> $GITHUB_OUTPUT
        echo "PR branch current version: $PR_VERSION"
    
    - name: Update version.json if needed
      id: update_version
      run: |
        EXPECTED_VERSION="${{ steps.new_version.outputs.version }}"
        CURRENT_VERSION="${{ steps.pr_version.outputs.version }}"
        
        if [ "$CURRENT_VERSION" != "$EXPECTED_VERSION" ]; then
          echo "Version mismatch detected!"
          echo "Expected: $EXPECTED_VERSION"
          echo "Current:  $CURRENT_VERSION"
          echo "Updating version.json..."
          
          # Update version.json with new version
          jq --arg version "$EXPECTED_VERSION" '.version = $version' version.json > version.json.tmp
          mv version.json.tmp version.json
          
          echo "needs_update=true" >> $GITHUB_OUTPUT
          echo "updated=true" >> $GITHUB_OUTPUT
        else
          echo "Version is correct: $CURRENT_VERSION"
          echo "needs_update=false" >> $GITHUB_OUTPUT
          echo "updated=false" >> $GITHUB_OUTPUT
        fi
    
    - name: Commit version update
      if: steps.update_version.outputs.needs_update == 'true'
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        
        git add version.json
        git commit -m "chore: bump version to ${{ steps.new_version.outputs.version }} [skip ci]"
        git push
    
    - name: Add comment to PR
      if: steps.update_version.outputs.updated == 'true'
      uses: actions/github-script@v8
      with:
        script: |
          const mainVersion = '${{ steps.main_version.outputs.version }}';
          const newVersion = '${{ steps.new_version.outputs.version }}';
          const incrementType = '${{ steps.version_type.outputs.type }}';
          
          let comment = `## ðŸ”– Version Auto-Update\n\n`;
          comment += `The version has been automatically updated based on this PR:\n\n`;
          comment += `- **Previous version** (main): \`${mainVersion}\`\n`;
          comment += `- **New version**: \`${newVersion}\`\n`;
          comment += `- **Increment type**: \`${incrementType.toUpperCase()}\`\n\n`;
          comment += `This update was automatically committed to the PR branch.\n\n`;
          comment += `### Versioning Rules\n`;
          comment += `- **MAJOR** (X.0.0): Breaking changes (e.g., \`feat!:\`, \`BREAKING CHANGE\`)\n`;
          comment += `- **MINOR** (0.X.0): New features (e.g., \`feat:\`, label: \`feature\`)\n`;
          comment += `- **PATCH** (0.0.X): Bug fixes and other changes (e.g., \`fix:\`, \`chore:\`)\n`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });
    
    - name: Add warning comment if no conventional commit
      if: steps.version_type.outputs.warning == 'true'
      uses: actions/github-script@v8
      with:
        script: |
          const comment = `## âš ï¸ Conventional Commit Format Recommended\n\n` +
            `This PR title doesn't follow conventional commit format. ` +
            `Consider updating it to one of:\n\n` +
            `- \`feat: description\` for new features (minor bump)\n` +
            `- \`fix: description\` for bug fixes (patch bump)\n` +
            `- \`feat!: description\` or \`fix!: description\` for breaking changes (major bump)\n` +
            `- \`chore:\`, \`docs:\`, \`style:\`, \`refactor:\`, \`perf:\`, \`test:\` for other changes\n\n` +
            `The version has been bumped as a **PATCH** by default.`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });
    
    - name: Verify version is ahead of main
      run: |
        MAIN_VERSION="${{ steps.main_version.outputs.version }}"
        NEW_VERSION="${{ steps.new_version.outputs.version }}"
        
        # Simple version comparison (assumes semantic versioning)
        if [ "$NEW_VERSION" = "$MAIN_VERSION" ]; then
          echo "ERROR: Version must be incremented from main ($MAIN_VERSION)"
          exit 1
        fi
        
        echo "âœ… Version check passed: $NEW_VERSION > $MAIN_VERSION"
