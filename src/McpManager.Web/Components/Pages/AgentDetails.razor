@page "/agents/{AgentId}"
@using McpManager.Core.Interfaces
@using McpManager.Core.Models
@inject IAgentManager AgentManager
@inject IServerManager ServerManager
@inject IInstallationManager InstallationManager
@inject NavigationManager Navigation

<PageTitle>Manage Agent - @agentName</PageTitle>

<div class="container-fluid">
    @if (agent == null)
    {
        <div class="alert alert-danger">
            <h4>Agent Not Found</h4>
            <p>The requested agent could not be found.</p>
            <a href="/agents" class="btn btn-primary">Back to Agents</a>
        </div>
    }
    else
    {
        <div class="row mb-4">
            <div class="col">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="/agents">Agents</a></li>
                        <li class="breadcrumb-item active">@agent.Name</li>
                    </ol>
                </nav>
                <h1>ü§ñ @agent.Name</h1>
                <p class="lead">Manage MCP servers for this agent</p>

                @if (!string.IsNullOrEmpty(syncError))
                {
                    <div class="alert alert-warning alert-dismissible fade show">
                        <strong>Sync Warning:</strong> @syncError
                        <button type="button" class="btn-close" @onclick="() => syncError = null"></button>
                    </div>
                }
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Installed Servers</h5>
                    </div>
                    <div class="card-body">
                        @if (!installedServers.Any())
                        {
                            <div class="alert alert-info mb-0">
                                <strong>No servers installed.</strong> Install servers from the <a href="/servers/browse">browse page</a>.
                            </div>
                        }
                        else
                        {
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Server Name</th>
                                            <th>Version</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var server in installedServers)
                                        {
                                            var installation = serverInstallations
                                                .FirstOrDefault(i => i.ServerId == server.Id && i.AgentId == AgentId);
                                            var isConfigured = installation != null;
                                            var isEnabled = installation?.IsEnabled ?? false;

                                            <tr>
                                                <td>
                                                    <strong>@server.Name</strong>
                                                    <div class="small text-muted">@server.Description</div>
                                                </td>
                                                <td>@server.Version</td>
                                                <td>
                                                    @if (isConfigured)
                                                    {
                                                        <span class="badge @(isEnabled ? "bg-success" : "bg-warning")">
                                                            @(isEnabled ? "‚úì Enabled" : "‚è∏ Disabled")
                                                        </span>
                                                    }
                                                    else
                                                    {
                                                        <span class="badge bg-secondary">Not Configured</span>
                                                    }
                                                </td>
                                                <td>
                                                    @if (isConfigured)
                                                    {
                                                        <div class="btn-group btn-group-sm">
                                                            <a href="/agents/@AgentId/servers/@Uri.EscapeDataString(server.Id)"
                                                               class="btn btn-outline-secondary">
                                                                ‚öôÔ∏è
                                                            </a>
                                                            <button class="btn btn-outline-primary" 
                                                                    @onclick="() => ToggleServerAsync(server.Id)">
                                                                @(isEnabled ? "‚è∏ Disable" : "‚ñ∂ Enable")
                                                            </button>
                                                            <button class="btn btn-outline-danger" 
                                                                    @onclick="() => RemoveServerAsync(server.Id)">
                                                                üóëÔ∏è Remove
                                                            </button>
                                                        </div>
                                                    }
                                                    else
                                                    {
                                                        <button class="btn btn-sm btn-success" 
                                                                @onclick="() => AddServerAsync(server.Id)">
                                                            ‚ûï Add to Agent
                                                        </button>
                                                    }
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        }
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">Agent Details</h5>
                    </div>
                    <div class="card-body">
                        <dl>
                            <dt>Agent Type</dt>
                            <dd>@agent.Type</dd>

                            <dt>Status</dt>
                            <dd><span class="badge bg-success">‚úì Detected</span></dd>

                            <dt>Configured Servers</dt>
                            <dd>@serverInstallations.Count(i => i.AgentId == AgentId)</dd>

                            <dt>Active Servers</dt>
                            <dd>@serverInstallations.Count(i => i.AgentId == AgentId && i.IsEnabled)</dd>

                            <dt>Config Path</dt>
                            <dd class="small font-monospace text-break">@agent.ConfigPath</dd>
                        </dl>
                    </div>
                </div>

                <div class="card mt-3">
                    <div class="card-body">
                        <h6 class="card-title">Quick Actions</h6>
                        <div class="d-grid gap-2">
                            <a href="/servers/browse" class="btn btn-primary btn-sm">
                                üîç Browse More Servers
                            </a>
                            <button class="btn btn-outline-secondary btn-sm" @onclick="RefreshDataAsync">
                                üîÑ Refresh
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {
    [Parameter]
    public string AgentId { get; set; } = string.Empty;

    private Agent? agent;
    private string agentName = string.Empty;
    private List<McpServer> installedServers = [];
    private List<ServerInstallation> serverInstallations = [];

    protected override async Task OnInitializedAsync()
    {
        await LoadDataAsync();
    }

    protected override async Task OnParametersSetAsync()
    {
        await LoadDataAsync();
    }

    private string? syncError = null;

    private async Task LoadDataAsync()
    {
        syncError = null;
        agent = await AgentManager.GetAgentByIdAsync(AgentId);
        agentName = agent?.Name ?? "Unknown Agent";

        if (agent != null)
        {
            var servers = await ServerManager.GetInstalledServersAsync();
            installedServers = servers.ToList();

            // Get installations from in-memory collection
            var installations = await InstallationManager.GetInstallationsByAgentIdAsync(AgentId);
            var installationsList = installations.ToList();

            // Sync with actual agent configuration - create installation records
            // for servers that exist in the agent's config file but aren't tracked yet
            foreach (var configServerId in agent.ConfiguredServerIds)
            {
                try
                {
                    // First, try to find by exact ID match
                    var server = await ServerManager.GetServerByIdAsync(configServerId);
                    var actualServerId = configServerId;

                    if (server == null)
                    {
                        // Server ID from config doesn't exist - try to find by name
                        // This handles the case where a server was installed with a different ID
                        var matchByName = installedServers.FirstOrDefault(s =>
                            s.Name.Equals(configServerId, StringComparison.OrdinalIgnoreCase));

                        if (matchByName != null)
                        {
                            // Found a server with matching name but different ID - use the existing one
                            actualServerId = matchByName.Id;
                            server = matchByName;
                            Console.WriteLine($"[AgentDetails] Config has '{configServerId}', matched to installed server '{actualServerId}' by name");
                        }
                        else
                        {
                            // No match found - DON'T create a duplicate
                            // The background worker will handle auto-discovery
                            Console.WriteLine($"[AgentDetails] Server '{configServerId}' not found, skipping (will be handled by background worker)");
                            continue;
                        }
                    }

                    // Check if installation relationship exists
                    var existingInstallation = installationsList.FirstOrDefault(i => i.ServerId == actualServerId);
                    if (existingInstallation == null)
                    {
                        // Create installation relationship using the actual server ID
                        await InstallationManager.AddServerToAgentAsync(actualServerId, AgentId);
                        Console.WriteLine($"[AgentDetails] Created installation: '{actualServerId}' -> '{AgentId}'");
                    }
                }
                catch (Exception ex)
                {
                    syncError = $"Error syncing server '{configServerId}': {ex.Message}";
                    Console.WriteLine($"[AgentDetails] Sync error for {configServerId}: {ex}");
                }
            }

            // Refresh installations after sync
            installations = await InstallationManager.GetInstallationsByAgentIdAsync(AgentId);
            serverInstallations = installations.ToList();
        }
    }

    private async Task AddServerAsync(string serverId)
    {
        await InstallationManager.AddServerToAgentAsync(serverId, AgentId);
        await LoadDataAsync();
    }

    private async Task RemoveServerAsync(string serverId)
    {
        await InstallationManager.RemoveServerFromAgentAsync(serverId, AgentId);
        await LoadDataAsync();
    }

    private async Task ToggleServerAsync(string serverId)
    {
        await InstallationManager.ToggleServerEnabledAsync(serverId, AgentId);
        await LoadDataAsync();
    }

    private async Task RefreshDataAsync()
    {
        await LoadDataAsync();
    }
}
