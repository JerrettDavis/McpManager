@page "/servers/browse"
@using McpManager.Core.Interfaces
@using McpManager.Application.Services
@using McpManager.Core.Models
@inject IServerBrowseService BrowseService
@inject IServerManager ServerManager
@inject NavigationManager Navigation
@implements IDisposable

<PageTitle>Browse MCP Servers</PageTitle>

<div class="container-fluid">
    <div class="row mb-4">
        <div class="col">
            <h1>üîç Browse MCP Servers</h1>
            <p class="lead">Discover and install MCP servers from the database cache</p>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-4">
            <div class="input-group input-group-lg">
                <input type="text" class="form-control" placeholder="Search servers..."
                       value="@_searchQuery" @oninput="OnSearchInput" />
                <span class="input-group-text">
                    @if (isSearching)
                    {
                        <div class="spinner-border spinner-border-sm" role="status">
                            <span class="visually-hidden">Searching...</span>
                        </div>
                    }
                    else
                    {
                        <span class="oi oi-magnifying-glass"></span>
                    }
                </span>
            </div>
            <small class="text-muted">Live search - results update as you type</small>
        </div>
        <div class="col-md-2">
            <select class="form-select form-select-lg" @bind="selectedRegistry" @bind:after="OnFilterChanged">
                <option value="">All Registries</option>
                @foreach (var registry in availableRegistries)
                {
                    <option value="@registry.Name">@registry.Name (@registry.ServerCount)</option>
                }
            </select>
        </div>
        <div class="col-md-2">
            <select class="form-select form-select-lg" @bind="sortBy" @bind:after="OnFilterChanged">
                <option value="downloads">Most Downloads</option>
                <option value="recent">Recently Updated</option>
                <option value="name">Name (A-Z)</option>
                <option value="score">Relevance</option>
            </select>
        </div>
        <div class="col-md-2">
            <select class="form-select form-select-lg" @bind="categoryFilter" @bind:after="OnFilterChanged">
                <option value="">All Categories</option>
                @foreach (var category in availableCategories.OrderBy(c => c))
                {
                    <option value="@category">@category</option>
                }
            </select>
        </div>
        <div class="col-md-2">
            <button class="btn btn-outline-secondary btn-lg w-100" @onclick="LoadDataAsync">
                <span class="oi oi-reload"></span> Refresh
            </button>
        </div>
    </div>

    @if (isLoading)
    {
        <div class="alert alert-info mb-4">
            <div class="d-flex align-items-center">
                <div class="spinner-border spinner-border-sm me-2" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <div class="flex-grow-1">
                    <strong>Loading servers from database...</strong>
                </div>
            </div>
        </div>
    }

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-warning alert-dismissible fade show">
            <strong>Warning:</strong> @errorMessage
            <button type="button" class="btn-close" @onclick="() => errorMessage = null"></button>
        </div>
    }

    @if (browseResult == null || !browseResult.Servers.Any())
    {
        <div class="alert alert-info">
            @if (isLoading)
            {
                <strong>Loading servers...</strong>
            }
            else if (!string.IsNullOrWhiteSpace(_searchQuery))
            {
                <strong>No servers found matching "@_searchQuery"</strong>
                <p>Try a different search term</p>
            }
            else
            {
                <strong>No servers available</strong>
                <p>The background worker will populate the database automatically</p>
                <div class="mt-2">
                    <small class="text-muted">Background refresh runs hourly - click Refresh to reload</small>
                </div>
            }
        </div>
    }
    else
    {
        <div class="mb-3">
            <small class="text-muted">
                Showing @browseResult.Servers.Count of @browseResult.TotalCount servers
                @if (availableRegistries.Any())
                {
                    <span> from @availableRegistries.Count registries</span>
                }
            </small>
        </div>
        
        <div class="row">
            @foreach (var result in browseResult.Servers)
            {
                <div class="col-md-6 col-lg-4 mb-4">
                    <div class="card h-100">
                        <div class="card-body">
                            <h5 class="card-title">@result.Server.Name</h5>
                            <h6 class="card-subtitle mb-2 text-muted">v@result.Server.Version</h6>
                            <p class="card-text">@result.Server.Description</p>
                            <div class="mb-2">
                                @foreach (var tag in result.Server.Tags.Take(3))
                                {
                                    <span class="badge bg-secondary me-1">@tag</span>
                                }
                            </div>
                            <small class="text-muted d-block mb-1">
                                <strong>@result.DownloadCount</strong> downloads ¬∑
                                Updated @FormatDate(result.LastUpdated)
                            </small>
                            <small class="text-muted">
                                <span class="badge bg-light text-dark">@result.RegistryName</span>
                            </small>
                        </div>
                        <div class="card-footer bg-transparent">
                            @if (result.Server.IsInstalled)
                            {
                                <button class="btn btn-success btn-sm w-100" disabled>
                                    ‚úì Installed
                                </button>
                            }
                            else
                            {
                                <button class="btn btn-primary btn-sm w-100" @onclick="() => InstallServerAsync(result.Server)">
                                    üì• Install
                                </button>
                            }
                        </div>
                    </div>
                </div>
            }
        </div>

        @if (browseResult.TotalPages > 1)
        {
            <nav aria-label="Server pagination">
                <ul class="pagination justify-content-center">
                    <li class="page-item @(currentPage == 1 ? "disabled" : "")">
                        <button class="page-link" @onclick="() => GoToPage(currentPage - 1)" disabled="@(currentPage == 1)">
                            Previous
                        </button>
                    </li>

                    @foreach (var pageNum in GetPageNumbers())
                    {
                        @if (pageNum == -1)
                        {
                            <li class="page-item disabled">
                                <span class="page-link">...</span>
                            </li>
                        }
                        else
                        {
                            <li class="page-item @(pageNum == currentPage ? "active" : "")">
                                <button class="page-link" @onclick="() => GoToPage(pageNum)">
                                    @pageNum
                                </button>
                            </li>
                        }
                    }

                    <li class="page-item @(currentPage == browseResult.TotalPages ? "disabled" : "")">
                        <button class="page-link" @onclick="() => GoToPage(currentPage + 1)" disabled="@(currentPage == browseResult.TotalPages)">
                            Next
                        </button>
                    </li>
                </ul>
            </nav>

            <div class="text-center text-muted mb-4">
                Showing @((currentPage - 1) * pageSize + 1) - @Math.Min(currentPage * pageSize, browseResult.TotalCount) of @browseResult.TotalCount servers
            </div>
        }
    }
</div>

@code {
    private string _searchQuery = string.Empty;
    private string selectedRegistry = string.Empty;
    private string sortBy = "downloads";
    private string categoryFilter = string.Empty;
    private ServerBrowseResult? browseResult;
    private List<RegistryInfo> availableRegistries = [];
    private HashSet<string> availableCategories = [];
    private string? errorMessage = null;
    private bool isLoading = false;
    private bool isSearching = false;

    private int currentPage = 1;
    private const int pageSize = 12;

    private System.Timers.Timer? _debounceTimer;
    private const int DebounceDelay = 300;

    protected override async Task OnInitializedAsync()
    {
        await LoadDataAsync();
    }

    private void OnSearchInput(ChangeEventArgs e)
    {
        _searchQuery = e.Value?.ToString() ?? string.Empty;
        DebounceSearch();
    }

    private async Task OnFilterChanged()
    {
        currentPage = 1;
        await LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        try
        {
            isLoading = true;
            isSearching = true;
            StateHasChanged();

            browseResult = await BrowseService.SearchServersAsync(
                searchQuery: string.IsNullOrWhiteSpace(_searchQuery) ? null : _searchQuery,
                registryFilter: string.IsNullOrWhiteSpace(selectedRegistry) ? null : selectedRegistry,
                categoryFilter: string.IsNullOrWhiteSpace(categoryFilter) ? null : categoryFilter,
                sortBy: sortBy,
                page: currentPage,
                pageSize: pageSize
            );

            var categoriesTask = BrowseService.GetAvailableCategoriesAsync();
            var registriesTask = BrowseService.GetRegistriesAsync();

            await Task.WhenAll(categoriesTask, registriesTask);

            availableCategories = categoriesTask.Result.ToHashSet(StringComparer.OrdinalIgnoreCase);
            availableRegistries = registriesTask.Result.ToList();

            await CheckInstalledStatusAsync();

            errorMessage = null;
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading servers: {ex.Message}";
        }
        finally
        {
            isLoading = false;
            isSearching = false;
            StateHasChanged();
        }
    }

    private void DebounceSearch()
    {
        _debounceTimer?.Stop();
        _debounceTimer?.Dispose();
        
        _debounceTimer = new System.Timers.Timer(DebounceDelay);
        _debounceTimer.Elapsed += async (sender, e) =>
        {
            _debounceTimer?.Stop();
            await InvokeAsync(async () =>
            {
                currentPage = 1;
                await LoadDataAsync();
            });
        };
        _debounceTimer.AutoReset = false;
        _debounceTimer.Start();
        
        isSearching = true;
        StateHasChanged();
    }

    private IEnumerable<int> GetPageNumbers()
    {
        if (browseResult == null) return [];
        
        var pages = new List<int>();
        var startPage = Math.Max(1, currentPage - 2);
        var endPage = Math.Min(browseResult.TotalPages, currentPage + 2);

        if (startPage > 1)
        {
            pages.Add(1);
            if (startPage > 2)
            {
                pages.Add(-1);
            }
        }

        for (int i = startPage; i <= endPage; i++)
        {
            pages.Add(i);
        }

        if (endPage < browseResult.TotalPages)
        {
            if (endPage < browseResult.TotalPages - 1)
            {
                pages.Add(-1);
            }
            pages.Add(browseResult.TotalPages);
        }

        return pages;
    }

    private async Task GoToPage(int page)
    {
        if (browseResult == null || page < 1 || page > browseResult.TotalPages) return;
        currentPage = page;
        await LoadDataAsync();
    }

    private async Task CheckInstalledStatusAsync()
    {
        if (browseResult == null) return;
        
        var installedServers = await ServerManager.GetInstalledServersAsync();
        var installedIds = installedServers.Select(s => s.Id).ToHashSet();

        foreach (var result in browseResult.Servers)
        {
            result.Server.IsInstalled = installedIds.Contains(result.Server.Id);
        }
    }

    private async Task InstallServerAsync(McpServer server)
    {
        await ServerManager.InstallServerAsync(server);
        server.IsInstalled = true;
        StateHasChanged();
    }

    private static string FormatDate(DateTime? date)
    {
        if (!date.HasValue) return "unknown";
        var days = (DateTime.UtcNow - date.Value).Days;
        return days switch
        {
            0 => "today",
            1 => "yesterday",
            < 30 => $"{days} days ago",
            < 365 => $"{days / 30} months ago",
            _ => $"{days / 365} years ago"
        };
    }

    public void Dispose()
    {
        _debounceTimer?.Stop();
        _debounceTimer?.Dispose();
    }
}
