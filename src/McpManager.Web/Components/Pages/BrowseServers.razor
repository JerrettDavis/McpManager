@page "/servers/browse"
@using McpManager.Core.Interfaces
@using McpManager.Core.Models
@inject IEnumerable<IServerRegistry> ServerRegistries
@inject IServerManager ServerManager
@inject NavigationManager Navigation

<PageTitle>Browse MCP Servers</PageTitle>

<div class="container-fluid">
    <div class="row mb-4">
        <div class="col">
            <h1>üîç Browse MCP Servers</h1>
            <p class="lead">Discover and install MCP servers from the registry</p>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-4">
            <div class="input-group input-group-lg">
                <input type="text" class="form-control" placeholder="Search servers..."
                       @bind="searchQuery" @bind:event="oninput" @onkeyup="HandleSearch" />
                <button class="btn btn-primary" @onclick="PerformSearchAsync">
                    <span class="oi oi-magnifying-glass"></span> Search
                </button>
            </div>
        </div>
        <div class="col-md-2">
            <select class="form-select form-select-lg" @bind="selectedRegistry" @bind:after="OnRegistryChanged">
                <option value="">All Registries</option>
                @foreach (var registry in ServerRegistries)
                {
                    <option value="@registry.Name">@registry.Name</option>
                }
            </select>
        </div>
        <div class="col-md-2">
            <select class="form-select form-select-lg" @bind="sortBy" @bind:after="ApplySortAndFilter">
                <option value="downloads">Most Downloads</option>
                <option value="recent">Recently Updated</option>
                <option value="name">Name (A-Z)</option>
                <option value="score">Relevance</option>
            </select>
        </div>
        <div class="col-md-2">
            <select class="form-select form-select-lg" @bind="categoryFilter" @bind:after="ApplySortAndFilter">
                <option value="">All Categories</option>
                @foreach (var category in availableCategories.OrderBy(c => c))
                {
                    <option value="@category">@category</option>
                }
            </select>
        </div>
        <div class="col-md-2">
            <button class="btn btn-outline-secondary btn-lg w-100" @onclick="RefreshAllAsync">
                <span class="oi oi-reload"></span> Refresh
            </button>
        </div>
    </div>

    <!-- Loading Status Bar -->
    @if (loadingRegistries.Any())
    {
        <div class="alert alert-info mb-4">
            <div class="d-flex align-items-center">
                <div class="spinner-border spinner-border-sm me-2" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <div class="flex-grow-1">
                    <strong>Loading servers...</strong>
                    <div class="mt-1">
                        @foreach (var registry in loadingRegistries)
                        {
                            <span class="badge bg-primary me-1">@registry</span>
                        }
                    </div>
                </div>
                <div class="text-end">
                    <small class="text-muted">@searchResults.Count servers loaded</small>
                </div>
            </div>
        </div>
    }
    else if (loadedRegistries.Any())
    {
        <div class="mb-3">
            <small class="text-muted">
                Loaded from @loadedRegistries.Count registries:
                @string.Join(", ", loadedRegistries.Select(r => $"{r.Name} ({r.Count})"))
            </small>
        </div>
    }

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-warning alert-dismissible fade show">
            <strong>Warning:</strong> @errorMessage
            <button type="button" class="btn-close" @onclick="() => errorMessage = null"></button>
        </div>
    }

    @if (!searchResults.Any() && !loadingRegistries.Any())
    {
        <div class="alert alert-info">
            <strong>No servers found.</strong> Try a different search term or wait for registries to load.
            <div class="mt-2">
                <small class="text-muted">Registries available: @ServerRegistries.Count()</small>
            </div>
        </div>
    }
    else
    {
        <div class="row">
            @foreach (var result in GetPagedResults())
            {
                <div class="col-md-6 col-lg-4 mb-4">
                    <div class="card h-100">
                        <div class="card-body">
                            <h5 class="card-title">@result.Server.Name</h5>
                            <h6 class="card-subtitle mb-2 text-muted">v@result.Server.Version</h6>
                            <p class="card-text">@result.Server.Description</p>
                            <div class="mb-2">
                                @foreach (var tag in result.Server.Tags.Take(3))
                                {
                                    <span class="badge bg-secondary me-1">@tag</span>
                                }
                            </div>
                            <small class="text-muted d-block mb-1">
                                <strong>@result.DownloadCount</strong> downloads ¬∑
                                Updated @FormatDate(result.LastUpdated)
                            </small>
                            <small class="text-muted">
                                <span class="badge bg-light text-dark">@result.RegistryName</span>
                            </small>
                        </div>
                        <div class="card-footer bg-transparent">
                            @if (result.Server.IsInstalled)
                            {
                                <button class="btn btn-success btn-sm w-100" disabled>
                                    ‚úì Installed
                                </button>
                            }
                            else
                            {
                                <button class="btn btn-primary btn-sm w-100" @onclick="() => InstallServerAsync(result.Server)">
                                    üì• Install
                                </button>
                            }
                        </div>
                    </div>
                </div>
            }

            <!-- Skeleton Loading Cards -->
            @if (loadingRegistries.Any())
            {
                @for (int i = 0; i < Math.Min(6, pageSize - GetPagedResults().Count()); i++)
                {
                    <div class="col-md-6 col-lg-4 mb-4">
                        <div class="card h-100">
                            <div class="card-body">
                                <div class="placeholder-glow">
                                    <h5 class="card-title placeholder col-6"></h5>
                                    <h6 class="card-subtitle mb-2 placeholder col-4"></h6>
                                    <p class="card-text">
                                        <span class="placeholder col-7"></span>
                                        <span class="placeholder col-4"></span>
                                        <span class="placeholder col-8"></span>
                                    </p>
                                    <span class="placeholder col-3 me-1"></span>
                                    <span class="placeholder col-3"></span>
                                </div>
                            </div>
                            <div class="card-footer bg-transparent">
                                <div class="placeholder-glow">
                                    <span class="placeholder col-12 btn"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            }
        </div>

        <!-- Pagination Controls -->
        @if (TotalPages > 1)
        {
            <nav aria-label="Server pagination">
                <ul class="pagination justify-content-center">
                    <!-- Previous Button -->
                    <li class="page-item @(currentPage == 1 ? "disabled" : "")">
                        <button class="page-link" @onclick="() => GoToPage(currentPage - 1)" disabled="@(currentPage == 1)">
                            Previous
                        </button>
                    </li>

                    <!-- Page Numbers -->
                    @foreach (var pageNum in GetPageNumbers())
                    {
                        @if (pageNum == -1)
                        {
                            <li class="page-item disabled">
                                <span class="page-link">...</span>
                            </li>
                        }
                        else
                        {
                            <li class="page-item @(pageNum == currentPage ? "active" : "")">
                                <button class="page-link" @onclick="() => GoToPage(pageNum)">
                                    @pageNum
                                </button>
                            </li>
                        }
                    }

                    <!-- Next Button -->
                    <li class="page-item @(currentPage == TotalPages ? "disabled" : "")">
                        <button class="page-link" @onclick="() => GoToPage(currentPage + 1)" disabled="@(currentPage == TotalPages)">
                            Next
                        </button>
                    </li>
                </ul>
            </nav>

            <div class="text-center text-muted mb-4">
                Showing @((currentPage - 1) * pageSize + 1) - @Math.Min(currentPage * pageSize, searchResults.Count) of @searchResults.Count servers
            </div>
        }
    }
</div>

@code {
    private string searchQuery = string.Empty;
    private string selectedRegistry = string.Empty;
    private string sortBy = "downloads"; // Default sort
    private string categoryFilter = string.Empty;
    private List<ServerSearchResult> allResults = []; // All loaded results
    private List<ServerSearchResult> searchResults = []; // Filtered and sorted results
    private HashSet<string> loadingRegistries = [];
    private List<(string Name, int Count)> loadedRegistries = [];
    private HashSet<string> availableCategories = [];
    private string? errorMessage = null;

    // Pagination
    private int currentPage = 1;
    private const int pageSize = 12; // 12 servers per page (3 columns x 4 rows)
    private int TotalPages => (int)Math.Ceiling((double)searchResults.Count / pageSize);

    protected override async Task OnInitializedAsync()
    {
        // Start loading immediately in background - don't await!
        _ = LoadAllServersProgressivelyAsync();
    }

    private async Task OnRegistryChanged()
    {
        await LoadAllServersProgressivelyAsync();
    }

    private async Task ApplySortAndFilter()
    {
        currentPage = 1;
        await Task.Run(() => UpdateSearchResults());
        StateHasChanged();
    }

    private void UpdateSearchResults()
    {
        var filtered = allResults.AsEnumerable();

        // Apply category filter
        if (!string.IsNullOrEmpty(categoryFilter))
        {
            filtered = filtered.Where(r => r.Server.Tags.Contains(categoryFilter, StringComparer.OrdinalIgnoreCase));
        }

        // Apply sorting
        filtered = sortBy switch
        {
            "downloads" => filtered.OrderByDescending(r => r.DownloadCount),
            "recent" => filtered.OrderByDescending(r => r.LastUpdated ?? DateTime.MinValue),
            "name" => filtered.OrderBy(r => r.Server.Name),
            "score" => filtered.OrderByDescending(r => r.Score),
            _ => filtered.OrderByDescending(r => r.DownloadCount)
        };

        lock (searchResults)
        {
            searchResults = filtered.ToList();
        }
    }

    private void ExtractCategories()
    {
        var allTags = allResults
            .SelectMany(r => r.Server.Tags)
            .Where(t => !string.IsNullOrEmpty(t))
            .Distinct(StringComparer.OrdinalIgnoreCase)
            .ToHashSet(StringComparer.OrdinalIgnoreCase);

        availableCategories = allTags;
    }

    private IEnumerable<ServerSearchResult> GetPagedResults()
    {
        return searchResults
            .Skip((currentPage - 1) * pageSize)
            .Take(pageSize);
    }

    private IEnumerable<int> GetPageNumbers()
    {
        var pages = new List<int>();
        var startPage = Math.Max(1, currentPage - 2);
        var endPage = Math.Min(TotalPages, currentPage + 2);

        // Always show first page
        if (startPage > 1)
        {
            pages.Add(1);
            if (startPage > 2)
            {
                pages.Add(-1); // Represents ellipsis
            }
        }

        // Show pages around current page
        for (int i = startPage; i <= endPage; i++)
        {
            pages.Add(i);
        }

        // Always show last page
        if (endPage < TotalPages)
        {
            if (endPage < TotalPages - 1)
            {
                pages.Add(-1); // Represents ellipsis
            }
            pages.Add(TotalPages);
        }

        return pages;
    }

    private void GoToPage(int page)
    {
        if (page < 1 || page > TotalPages) return;
        currentPage = page;
        StateHasChanged();
    }

    private async Task LoadAllServersProgressivelyAsync()
    {
        errorMessage = null;
        currentPage = 1;
        allResults.Clear();
        searchResults.Clear();
        loadedRegistries.Clear();
        loadingRegistries.Clear();
        availableCategories.Clear();

        var registries = string.IsNullOrEmpty(selectedRegistry)
            ? ServerRegistries
            : ServerRegistries.Where(r => r.Name == selectedRegistry);

        var registryList = registries.ToList();

        // Mark all as loading
        foreach (var registry in registryList)
        {
            loadingRegistries.Add(registry.Name);
        }
        StateHasChanged();

        // Load from each registry in parallel
        var tasks = registryList.Select(async registry =>
        {
            try
            {
                var results = await registry.GetAllServersAsync();
                var resultList = results.ToList();

                // Add results to the shared list (thread-safe on Blazor Server)
                lock (allResults)
                {
                    allResults.AddRange(resultList);
                    loadingRegistries.Remove(registry.Name);
                    loadedRegistries.Add((registry.Name, resultList.Count));
                    
                    // Update categories and apply sorting as we load
                    ExtractCategories();
                    UpdateSearchResults();
                }

                // Update UI after each registry completes
                await InvokeAsync(StateHasChanged);
            }
            catch (Exception ex)
            {
                lock (allResults)
                {
                    loadingRegistries.Remove(registry.Name);
                }
                errorMessage = $"Error loading from {registry.Name}: {ex.Message}";
                await InvokeAsync(StateHasChanged);
            }
        });

        await Task.WhenAll(tasks);

        // Deduplicate after all loaded
        lock (allResults)
        {
            allResults = allResults
                .GroupBy(r => r.Server.Id)
                .Select(g => g.OrderByDescending(x => x.DownloadCount).First())
                .ToList();
            
            ExtractCategories();
            UpdateSearchResults();
        }

        await CheckInstalledStatusAsync();
        await InvokeAsync(StateHasChanged);
    }

    private async Task RefreshAllAsync()
    {
        await LoadAllServersProgressivelyAsync();
    }

    private async Task PerformSearchAsync()
    {
        if (string.IsNullOrWhiteSpace(searchQuery))
        {
            await LoadAllServersProgressivelyAsync();
            return;
        }

        errorMessage = null;
        currentPage = 1;
        allResults.Clear();
        searchResults.Clear();
        loadedRegistries.Clear();
        loadingRegistries.Clear();
        availableCategories.Clear();

        var registries = string.IsNullOrEmpty(selectedRegistry)
            ? ServerRegistries
            : ServerRegistries.Where(r => r.Name == selectedRegistry);

        var registryList = registries.ToList();

        foreach (var registry in registryList)
        {
            loadingRegistries.Add(registry.Name);
        }
        StateHasChanged();

        // Search registries in parallel
        var tasks = registryList.Select(async registry =>
        {
            try
            {
                var results = await registry.SearchAsync(searchQuery);
                var resultList = results.ToList();

                lock (allResults)
                {
                    allResults.AddRange(resultList);
                    loadingRegistries.Remove(registry.Name);
                    loadedRegistries.Add((registry.Name, resultList.Count));
                    
                    // Update categories and results as we load
                    ExtractCategories();
                    UpdateSearchResults();
                }

                await InvokeAsync(StateHasChanged);
            }
            catch (Exception ex)
            {
                lock (allResults)
                {
                    loadingRegistries.Remove(registry.Name);
                }
                errorMessage = $"Error searching {registry.Name}: {ex.Message}";
                await InvokeAsync(StateHasChanged);
            }
        });

        await Task.WhenAll(tasks);

        // Deduplicate and sort
        lock (allResults)
        {
            allResults = allResults
                .GroupBy(r => r.Server.Id)
                .Select(g => g.OrderByDescending(x => x.Score).First())
                .ToList();
            
            ExtractCategories();
            // For search, default to score-based sorting
            sortBy = "score";
            UpdateSearchResults();
        }

        await CheckInstalledStatusAsync();
        await InvokeAsync(StateHasChanged);
    }

    private async Task HandleSearch(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await PerformSearchAsync();
        }
    }

    private async Task CheckInstalledStatusAsync()
    {
        var installedServers = await ServerManager.GetInstalledServersAsync();
        var installedIds = installedServers.Select(s => s.Id).ToHashSet();

        foreach (var result in searchResults)
        {
            result.Server.IsInstalled = installedIds.Contains(result.Server.Id);
        }
    }

    private async Task InstallServerAsync(McpServer server)
    {
        await ServerManager.InstallServerAsync(server);
        server.IsInstalled = true;
        StateHasChanged();
    }

    private static string FormatDate(DateTime? date)
    {
        if (!date.HasValue) return "unknown";
        var days = (DateTime.UtcNow - date.Value).Days;
        return days switch
        {
            0 => "today",
            1 => "yesterday",
            < 30 => $"{days} days ago",
            < 365 => $"{days / 30} months ago",
            _ => $"{days / 365} years ago"
        };
    }
}
